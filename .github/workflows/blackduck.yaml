name: 'Blackduck Scan'

on:
  push:
    branches: ["update-blackduck-action"]
  workflow_dispatch:
  # schedule:
  #   - cron: 0 23 * * *

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v3
      - run: git fetch --depth=1
      - name: Setup java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"
          cache: maven

      # Fixme: Use major version from pom once it is 5.x
      - name: Get SDK Version
        run: |
          echo "project_version_NOT_YET_IN_USE=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout | cut -d '.' -f 1)" >> $GITHUB_ENV

      - name: Blackduck Scan
        uses: SAP/project-piper-action@27cadf261545552a68660531476c0915a97ee3d8
        with:
          command: detectExecuteScan
          flags: \
            --version=$PROJECT_VERSION \
        env:
          PIPER_token: ${{ secrets.BLACKDUCK_TOKEN }}
          PROJECT_VERSION: "5"


# jobs:
#   build:
#     runs-on: [ ubuntu-latest ]
#     steps:
#       - name: Checkout Source
#         uses: actions/checkout@v3

#       - name: Black Duck Full Scan
#         if: ${{ github.event_name != 'pull_request' }}
#         uses: synopsys-sig/synopsys-action@v1.3.0
#         ### Use below configuration to set specific detect environment variables
#         env:
#           DETECT_PROJECT_NAME: "SHC - CLOUD SDK"
#           DETECT_PROJECT_VERSION_NAME: "5"
#           DETECT_TIMEOUT: 7200
#           # DETECT_MAVEN_EXCLUDED_MODULES: "s4hana-all,s4hana-api-odata,s4hana-api-odata-onpremise,s4hana-api-odata-v4,s4hana-api-odata-v4-onpremise,s4hana-api-parent,end-to-end-tests,performance-tests,tests-parent,unit-tests,vdm-integration-tests,testutil-core,testutil-parent"
#           DETECT_MAVEN_EXCLUDED_MODULES: "tests-parent,testutil-core,testutil-parent"
#           # DETECT_MAVEN_BUILD_COMMAND: "-pl !:s4hana-all,!:s4hana-api-odata,!:s4hana-api-odata-onpremise,!:s4hana-api-odata-v4,!:s4hana-api-odata-v4-onpremise,!:s4hana-api-parent,!:end-to-end-tests,!:performance-tests,!:tests-parent,!:unit-tests,!:vdm-integration-tests,!:testutil-core,!:testutil-parent"
#           DETECT_MAVEN_BUILD_COMMAND: "-pl !:tests-parent,!:testutil-core,!:testutil-parent"
#           DETECT_MAVEN_EXCLUDED_SCOPES: "provided,test"
#           DETECT_LATEST_RELEASE_VERSION: 8.10.0
#         with:
#           blackduck_url: ${{ secrets.BLACKDUCK_URL }}
#           blackduck_apiToken: ${{ secrets.BLACKDUCK_TOKEN }}
#           blackduck_scan_full: true
#           ### Accepts Multiple Values
#           blackduck_scan_failure_severities: 'BLOCKER,CRITICAL,MAJOR'
#           ### Uncomment below configuration to enable automatic fix pull request creation if vulnerabilities are reported
#           # blackduck_automation_fixpr: true
#           # github_token:  # Mandatory when blackduck_automation_fixpr is set to 'true'
#           ### Uncomment below configuration if Synopsys Bridge diagnostic files needs to be uploaded
#           # include_diagnostics: true

#       # - name: Black Duck PR Scan
#       #
#       #   uses: synopsys-sig/synopsys-action@v1.3.0
#       #   ### Use below configuration to set specific detect environment variables
#       #   env:
#       #     DETECT_PROJECT_NAME: SHC - CLOUD SDK
#       #     DETECT_PROJECT_VERSION_NAME: 5
#       #   with:
#       #     blackduck_url: {{ secrets.BLACKDUCK_URL }}
#       #     blackduck_apiToken: {{ secrets.BLACKDUCK_API_TOKEN }}
#       #     blackduck_scan_full: false
#       #     ### Below configuration is used to enable automatic pull request comment based on Black Duck scan result
#       #     blackduck_automation_prcomment: true
#       #     github_token: {{ secrets.GITHUB_TOKEN }} # Mandatory when blackduck_automation_prcomment is set to 'true'
#       #     ### Uncomment below configuration if Synopsys Bridge diagnostic files needs to be uploaded
#       #     # include_diagnostics: true