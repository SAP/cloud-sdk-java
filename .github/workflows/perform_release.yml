name: Perform Release

on:
  release:
    types: [published]

env:
  MVN_CLI_ARGS: "--batch-mode --no-transfer-progress --fail-at-end --show-version"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      branch_name: ${{ steps.download-asset.outputs.BRANCH_NAME }}
    steps:
      - name: Setup java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"
          server-id: artifactory-snapshots
          server-username: ARTIFACTORY_USER # env variable for username in deploy
          server-password: ARTIFACTORY_TOKEN # env variable for token in deploy

      - name: Download Release Asset
        id: download-asset
        run: |
          GIT_TAG=${{ github.event.release.tag_name }}
          echo Git Tag "$GIT_TAG"

          BRANCH_NAME=`python -c "print('RELEASE-' + '$GIT_TAG'.replace('rel/', ''))"`
          echo Branch Name "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT

          gh release download "$GIT_TAG" --dir ./ --repo "SAP/cloud-sdk-java"
          unzip sap-cloud-sdk-java-*.zip -d .
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#      - name: Perform Release
#        working-directory: ./release
#        run: >
#          mvn
#          $MVN_CLI_ARGS
#          -Durl=https://common.repositories.cloud.sap/artifactory/build-snapshots-cloudsdk
#          -DrepositoryId=artifactory-snapshots
#          -Dmaven.install.skip=true
#          deploy
#
#        env:
#          ARTIFACTORY_USER: ${{ secrets.ARTIFACTORY_USER }}
#          ARTIFACTORY_TOKEN: ${{ secrets.ARTIFACTORY_TOKEN }}

      - name: Get SDK Major Version
        run: |
          echo "MAJOR_VERSION=$(echo $GIT_TAG | awk -F'/' '{print $2}' | awk -F'.' '{print $1}')" >> $GITHUB_ENV
        env:
          GIT_TAG: ${{ github.event.release.tag_name }}

      - name: Checkout SAP/cloud-sdk
        uses: actions/checkout@v3
        with:
          repository: SAP/cloud-sdk
          path: cloud-sdk

      - name: Prepare git
        working-directory: ./cloud-sdk
        run: |
          git config --global user.email "noreply+s4hana-cloud-sdk@sap.com"
          git config --global user.name "Maven Central Release Script"

      - name: Extract JavaDoc
        working-directory: ./cloud-sdk
        env:
          MAJOR_VERSION: ${{ env.MAJOR_VERSION }}
        run: |
          TARGET_DIR=static/java-api/v$MAJOR_VERSION
          rm -rf $TARGET_DIR
          unzip ../sap-cloud-sdk-java-*.zip -d $TARGET_DIR
          tree static/java-api
          
          git add -A $TARGET_DIR
          git commit -m "Update Cloud SDK for JavaDoc v$MAJOR_VERSION"

      - name: Create JavaDoc PR
        working-directory: ./cloud-sdk
        run: |
          
          

      - name: Merge Release Branch
        run: gh pr merge --rebase "${{ steps.download-asset.outputs.BRANCH_NAME }}" --repo "SAP/cloud-sdk-java"

  notify-job:
    runs-on: ubuntu-latest
    needs: [ release ]
    if: ${{ failure() }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Notify
        run: python .pipeline/scripts/notify.py
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          WORKFLOW: ${{ github.workflow }}
          WORKFLOW_RUN_URL: https://github.com/SAP/cloud-sdk-java/actions/runs/${{ github.run_id }}
          BRANCH_NAME: ${{ needs.release.outputs.branch_name }}
